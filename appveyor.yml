image: Visual Studio 2022
configuration: Release
platform: Any CPU
skip_tags: true

services:
  - mssql2017
  - msmq

install:
  # Install .NET 10 SDK (adjust version if needed)
  - ps: |
      Write-Host "Installing .NET 10 SDK..."
      $dotnetInstallScript = "$env:temp\dotnet-install.ps1"
      Invoke-WebRequest https://dot.net/v1/dotnet-install.ps1 -OutFile $dotnetInstallScript
      & $dotnetInstallScript -Channel 10.0 -InstallDir "C:\Program Files\dotnet" -NoPath
      dotnet --info

  # Existing install steps
  - ps: $env:version_file_path = ".\version.props"
  - ps: gitversion /output buildserver
  - ps: $env:major_version = (Select-Xml -Path $env:version_file_path -XPath "/Project/PropertyGroup/MajorVersion" | Select-Object -ExpandProperty Node).InnerText
  - ps: $env:minor_version = (Select-Xml -Path $env:version_file_path -XPath "/Project/PropertyGroup/MinorVersion" | Select-Object -ExpandProperty Node).InnerText
  - ps: $env:release_version = [string]([int]((Select-Xml -Path $env:version_file_path -XPath "/Project/PropertyGroup/ReleaseVersion" | Select-Object -ExpandProperty Node).InnerText) + 1)
  - ps: $env:revision = $env:GitVersion_CommitsSinceVersionSource
  - ps: Update-AppveyorBuild -Version "$env:major_version.$env:minor_version.$env:release_version.$env:revision.$env:APPVEYOR_BUILD_NUMBER"
  - ps: $xReleaseVersion = Select-Xml -Path $env:version_file_path -XPath "/Project/PropertyGroup/ReleaseVersion"
  - ps: $xReleaseVersion.Node.InnerText = $env:release_version
  - ps: $xReleaseVersion.Node.OwnerDocument.Save($xReleaseVersion.Path)
  - ps: $xRevision = Select-Xml -Path $env:version_file_path -XPath "/Project/PropertyGroup/Revision"
  - ps: $xRevision.Node.InnerText = $env:revision
  - ps: $xRevision.Node.OwnerDocument.Save($xRevision.Path)
  - ps: |
      Write-Host "Checking MSMQ service..."
      $service = Get-Service MSMQ -ErrorAction SilentlyContinue
      if ($service) {
        Write-Host "MSMQ Service Status: $($service.Status)"
        if ($service.Status -ne "Running") {
          Start-Service MSMQ
          Write-Host "Started MSMQ Service."
        }
      } else {
        Write-Error "MSMQ Service not found on this image."
        exit 1
      }

dotnet_csproj:
  patch: false

before_build:
  - cmd: dotnet --version
  - cmd: dotnet restore "source\Logging.sln"

build:
  project: source\Logging.sln
  parallel: true
  verbosity: minimal

after_build:
  - cmd: scripts\InstallTestAssemblies.bat
  - cmd: scripts\CreateLoggingDatabase.bat
  - dir /s /b

after_test:
  - cmd: scripts\UninstallTestAssemblies.bat
  - cmd: scripts\DropLoggingDatabase.bat

artifacts:
- path: 'bin\Release\EnterpriseLibrary.Logging.*.nupkg'
  name: 'EnterpriseLibrary.Logging'

#on_success:
#  - ps: git config --global credential.helper store
#  - ps: Add-Content "$HOME\.git-credentials" "https://$($env:github_access_token):x-oauth-basic@github.com`n"
#  - ps: git config --global user.email "$env:github_email"
#  - ps: git config --global user.name "$env:github_name"
#  - git pull
#  - git commit -m "Revision update by AppVeyor [ci skip]" -- version.props
#  - git push

 